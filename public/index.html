<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#7c3aed">
  <meta name="description" content="High Performance Habit Tracker">
  <title>Focus & Habit Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¡</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { gray: { 750: '#2d3748', 850: '#1a202c', 950: '#171923' } } } }
    }
  </script>
  <style>
    body { transition: background-color 0.3s ease, color 0.3s ease; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100 transition-colors duration-200">
  
  <div id="loading" class="flex items-center justify-center h-screen text-xl font-semibold text-gray-600 dark:text-gray-300">
    Connecting to Services...
  </div>
  <div id="root" style="display: none;"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURATION ZONE ---
    const firebaseConfig = {
      apiKey: "AIzaSyC2ZcVS5_j5YVyFThdISm9MFpQNMDwdVHM",
      authDomain: "habit-tracker-edgar.firebaseapp.com",
      projectId: "habit-tracker-edgar",
      storageBucket: "habit-tracker-edgar.firebasestorage.app",
      messagingSenderId: "574788691312",
      appId: "1:574788691312:web:eff4f0d2f1386d081b1bb5"
    };

    // Initialize Firebase
    let app, auth, db;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    } catch (e) {
      console.warn("Firebase not configured yet. App will run in Offline Mode.");
    }

    window.fbServices = { auth, db, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, doc, onSnapshot, setDoc, getDoc };
    
    // --- 1. UTILS ---
    window.utils = {
      generateId: () => Math.random().toString(36).substr(2, 9),
      formatTime: (s) => `${Math.floor(s/3600)>0?Math.floor(s/3600)+':':''}${Math.floor((s%3600)/60).toString().padStart(Math.floor(s/3600)>0?2:1,'0')}:${(s%60).toString().padStart(2,'0')}`,
      playNotificationSound: () => { try { const a=new(window.AudioContext||window.webkitAudioContext)(); const o=a.createOscillator(); const g=a.createGain(); o.connect(g); g.connect(a.destination); o.frequency.setValueAtTime(500,a.currentTime); g.gain.exponentialRampToValueAtTime(0.01,a.currentTime+0.5); o.start(); o.stop(a.currentTime+0.5); } catch(e){} },
      Icon: ({ name, size = 20, className = '' }) => { const i = { home: 'ðŸ ', tasks: 'â˜‘ï¸', clock: 'â±ï¸', list: 'ðŸ“‹', shop: 'ðŸ›ï¸', plus: 'âž•', trash: 'ðŸ—‘ï¸', check: 'âœ…', pass: 'ðŸŽ«', moon: 'ðŸŒ™', sun: 'â˜€ï¸', critical: 'â€¼ï¸', settings: 'âš™ï¸', bell: 'ðŸ””', clear: 'âŒ' }; return React.createElement('span', { className: `inline-flex items-center justify-center select-none ${className}`, style: { fontSize: size } }, i[name] || '?'); }
    };

    document.getElementById('loading').style.display = 'none';
    document.getElementById('root').style.display = 'block';
    
    const { useState, useEffect, useRef } = React;
    const { Icon, generateId, formatTime, playNotificationSound } = window.utils;

    // --- 2. COMPONENTS ---

    const StatCard = ({ label, value, color }) => React.createElement('div', { className: `bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-l-4 border-${color}-500` }, React.createElement('div', { className: 'text-sm text-gray-500 dark:text-gray-400' }, label), React.createElement('div', { className: 'text-2xl font-bold' }, value));

    const DashboardView = ({ habits, history, points, passes, bankedTime, tasks, usePass, completeHabit, categories }) => {
      const today = new Date().toISOString().split('T')[0];
      const activeTasksCount = tasks.filter(t => !t.completed).length;

      const categorizedHabits = categories.map(cat => ({
        name: cat,
        items: habits.filter(h => h.category === cat).sort((a,b) => (a.time || '23:59').localeCompare(b.time || '23:59'))
      })).filter(g => g.items.length > 0);

      return React.createElement('div', { className: 'space-y-6 fade-in' },
        React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
          React.createElement(StatCard, { label: 'Points Balance', value: points, color: 'purple' }),
          React.createElement(StatCard, { label: 'Emergency Passes', value: `${passes} / 3`, color: 'blue' }),
          React.createElement(StatCard, { label: 'Banked Break', value: formatTime(bankedTime), color: 'green' }),
          React.createElement(StatCard, { label: 'Pending Tasks', value: activeTasksCount, color: 'orange' })
        ),
        
        categorizedHabits.length === 0 && React.createElement('div', { className: 'text-center py-10 opacity-50' }, 'No habits set up. Go to Habit Management to add some!'),
        
        categorizedHabits.map(group => 
          React.createElement('div', { key: group.name, className: 'space-y-3' },
            React.createElement('h3', { className: 'text-lg font-bold text-gray-600 dark:text-gray-300 ml-1' }, group.name),
            group.items.map(habit => {
              const status = history[today]?.[habit.id] || {};
              const isCompleted = status.completed;
              let borderClass = habit.priority === 'Critical' ? 'border-l-4 border-red-500' : habit.priority === 'High' ? 'border-l-4 border-orange-400' : 'border-transparent';
              
              return React.createElement('div', { key: habit.id, className: `bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm flex items-center justify-between border ${borderClass} transition-all ${isCompleted ? 'opacity-60 grayscale' : ''}` },
                React.createElement('div', { className: 'flex-1' },
                  React.createElement('div', { className: 'flex items-center gap-2' },
                    React.createElement('span', { className: 'font-semibold text-lg' }, habit.name),
                    habit.priority === 'Critical' && React.createElement(Icon, { name: 'critical', className: 'text-red-500' }),
                    habit.time && React.createElement('span', { className: 'text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500' }, habit.time)
                  ),
                  React.createElement('div', { className: 'text-xs text-gray-500 mt-1 flex gap-3' },
                    React.createElement('span', { className: 'text-purple-500 font-medium' }, `+${habit.points} pts`),
                    status.type === 'pass' && React.createElement('span', { className: 'text-blue-500' }, 'Used Pass')
                  )
                ),
                !isCompleted ? React.createElement('div', { className: 'flex gap-2' },
                  React.createElement('button', { onClick: () => usePass(habit.id), disabled: passes <= 0, className: 'p-2 text-blue-500 bg-blue-50 dark:bg-blue-900/20 rounded-lg disabled:opacity-30' }, React.createElement(Icon, { name: 'pass', size: 22 })),
                  React.createElement('button', { onClick: () => completeHabit(habit.id), className: 'p-2 text-green-500 bg-green-50 dark:bg-green-900/20 rounded-lg' }, React.createElement(Icon, { name: 'check', size: 22 }))
                ) : React.createElement('div', { className: 'text-green-500 font-bold px-4' }, 'Done')
              );
            })
          )
        )
      );
    };

    const TasksView = ({ tasks, updateTasks, setShowTaskModal, deleteTask }) => {
      const [, forceUpdate] = useState(0);
      useEffect(() => {
        const i = setInterval(() => forceUpdate(n => n + 1), 1000);
        return () => clearInterval(i);
      }, []);

      const getCountdown = (due) => {
        if (!due) return null;
        const now = new Date();
        const target = new Date(due);
        const diff = target - now;
        
        if (diff < 0) return { text: 'Overdue', color: 'text-red-500 font-bold' };
        if (diff < 3600000) {
           const mins = Math.floor(diff / 60000);
           const secs = Math.floor((diff % 60000) / 1000);
           return { text: `${mins}m ${secs}s left`, color: 'text-orange-500 font-bold animate-pulse' };
        }
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(hours / 24);
        if (days > 0) return { text: `${days}d left`, color: 'text-blue-500' };
        return { text: `${hours}h left`, color: 'text-blue-500' };
      };

      const sortedTasks = tasks.filter(t => !t.completed).sort((a,b) => {
        const priorityOrder = { 'A': 1, 'B': 2, 'C': 3, 'D': 4 };
        if (a.priority !== b.priority) return priorityOrder[a.priority] - priorityOrder[b.priority];
        return new Date(a.due || 0) - new Date(b.due || 0);
      });

      return React.createElement('div', { className: 'space-y-6 fade-in' }, 
        React.createElement('div', { className: 'flex justify-between items-center' }, 
          React.createElement('h2', { className: 'text-2xl font-bold' }, 'Task Manager'), 
          React.createElement('button', { onClick: () => setShowTaskModal(true), className: 'bg-purple-600 text-white px-4 py-2 rounded-lg flex gap-2 shadow hover:bg-purple-700 transition' }, React.createElement(Icon, { name: 'plus' }), 'New Task')
        ),
        
        sortedTasks.map(task => {
          const cd = getCountdown(task.due);
          const priorityColors = { 'A': 'border-red-500 bg-red-50 dark:bg-red-900/10', 'B': 'border-orange-500 bg-orange-50 dark:bg-orange-900/10', 'C': 'border-blue-500 bg-blue-50 dark:bg-blue-900/10', 'D': 'border-gray-400 bg-gray-50 dark:bg-gray-800' };
          
          return React.createElement('div', { key: task.id, className: `p-4 rounded-lg shadow-sm flex items-start gap-3 border-l-4 ${priorityColors[task.priority]} bg-white dark:bg-gray-800` }, 
             React.createElement('button', { onClick: () => updateTasks(tasks.map(t => t.id === task.id ? { ...t, completed: !t.completed } : t)), className: 'mt-1 w-5 h-5 border-2 border-gray-400 rounded hover:border-purple-500' }),
             React.createElement('div', { className: 'flex-1' }, 
               React.createElement('div', { className: 'font-medium flex justify-between' }, 
                 task.title,
                 cd && React.createElement('span', { className: `text-xs ${cd.color}` }, cd.text)
               ), 
               React.createElement('div', { className: 'text-xs opacity-70 mt-1' }, 
                 `${task.category} â€¢ Priority ${task.priority}`,
                 task.due && ` â€¢ Due: ${new Date(task.due).toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}`
               )
             ),
             React.createElement('button', { onClick: () => deleteTask(task.id), className: 'text-gray-400 hover:text-red-500 transition' }, React.createElement(Icon, { name: 'trash' }))
          );
        }),
        
        tasks.some(t => t.completed) && React.createElement('div', { className: 'mt-8 pt-4 border-t border-gray-200 dark:border-gray-700' },
          React.createElement('div', { className: 'flex justify-between items-center mb-4' },
             React.createElement('h3', { className: 'text-gray-500 font-medium' }, 'Completed'),
             React.createElement('button', { onClick: () => updateTasks(tasks.filter(t => !t.completed)), className: 'text-xs text-red-500 hover:underline' }, 'Delete All Completed')
          ),
          tasks.filter(t => t.completed).map(task => React.createElement('div', { key: task.id, className: 'flex items-center gap-3 py-2 opacity-50 hover:opacity-100 transition' }, 
             React.createElement(Icon, { name: 'check', size: 16 }), 
             React.createElement('span', { className: 'line-through flex-1' }, task.title), 
             React.createElement('button', { onClick: () => updateTasks(tasks.map(t => t.id === task.id ? { ...t, completed: !t.completed } : t)), className: 'text-xs underline text-blue-500 mr-2' }, 'Undo'),
             React.createElement('button', { onClick: () => deleteTask(task.id), className: 'text-xs text-red-500' }, React.createElement(Icon, { name: 'trash', size: 14 }))
          ))
        )
      );
    };

    const HabitsView = ({ habits, updateHabits, categories }) => {
       const [form, setForm] = useState({ name: '', points: 20, priority: 'Normal', time: '', category: 'Morning' });
       return React.createElement('div', { className: 'space-y-6 fade-in' },
         React.createElement('h2', { className: 'text-2xl font-bold' }, 'Habit Management'),
         React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow border border-purple-500/20 space-y-4' },
           React.createElement('h3', { className: 'font-bold' }, 'Create New Habit'),
           React.createElement('div', { className: 'grid md:grid-cols-2 gap-4' },
             React.createElement('input', { className: 'w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600', placeholder: 'Habit Name', value: form.name, onChange: e => setForm({...form, name: e.target.value}) }),
             React.createElement('select', { className: 'w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600', value: form.category, onChange: e => setForm({...form, category: e.target.value}) }, categories.map(c => React.createElement('option', { key:c, value:c }, c))),
             React.createElement('select', { className: 'w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600', value: form.priority, onChange: e => setForm({...form, priority: e.target.value}) }, ['Normal', 'High', 'Critical'].map(p => React.createElement('option', { key:p, value:p }, p))),
             React.createElement('input', { type: 'time', className: 'w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600', value: form.time, onChange: e => setForm({...form, time: e.target.value}) })
           ),
           React.createElement('button', { onClick: () => { if(form.name) { updateHabits([...habits, { ...form, id: generateId(), points: Math.round(form.points * (form.priority==='Critical'?2:1)) }]); setForm({...form, name:'', points: 20, priority: 'Normal', time: '', category: 'Morning'}); } }, className: 'bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition' }, 'Add Habit')
         ),
         habits.map(h => React.createElement('div', { key: h.id, className: 'flex justify-between p-4 bg-white dark:bg-gray-800 rounded shadow-sm items-center' }, 
           React.createElement('div', null, React.createElement('div', { className: 'font-bold' }, h.name), React.createElement('div', { className: 'text-sm opacity-60' }, `${h.category} â€¢ ${h.time || 'Anytime'}`)),
           React.createElement('button', { onClick: () => updateHabits(habits.filter(x => x.id !== h.id)), className: 'text-red-500 p-2 hover:bg-red-50 rounded' }, React.createElement(Icon, { name: 'trash' }))
         ))
       );
    };

    const RewardsView = ({ rewards, points, updatePoints, updateRewards }) => {
      const [form, setForm] = useState({ name: '', cost: 50 });
      return React.createElement('div', { className: 'space-y-6 fade-in' },
        React.createElement('div', { className: 'flex justify-between items-center' },
           React.createElement('h2', { className: 'text-2xl font-bold' }, `Rewards (Bal: ${points})`),
           React.createElement('div', { className: 'flex gap-2' },
             React.createElement('input', { className: 'p-2 border rounded dark:bg-gray-700 dark:border-gray-600', placeholder: 'Reward Name', value: form.name, onChange: e=>setForm({...form, name:e.target.value}) }),
             React.createElement('input', { type: 'number', className: 'w-20 p-2 border rounded dark:bg-gray-700 dark:border-gray-600', placeholder: 'Cost', value: form.cost, onChange: e=>setForm({...form, cost: parseInt(e.target.value)||0}) }),
             React.createElement('button', { onClick: ()=>{ if(form.name){ updateRewards([...rewards, {...form, id:generateId()}]); setForm({name:'', cost:50}); }}, className: 'bg-green-600 text-white px-3 rounded' }, React.createElement(Icon, { name: 'plus' }))
           )
        ),
        React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-3 gap-4' }, rewards.map(r => 
          React.createElement('div', { key: r.id, className: 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow flex flex-col justify-between h-36 relative group' }, 
            React.createElement('button', { onClick: () => updateRewards(rewards.filter(x => x.id !== r.id)), className: 'absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition' }, React.createElement(Icon, { name: 'trash', size: 16 })),
            React.createElement('div', { className: 'font-bold text-lg' }, r.name), 
            React.createElement('button', { onClick: () => { if (points >= r.cost) updatePoints(points - r.cost); }, className: `py-2 rounded font-bold transition ${points >= r.cost ? 'bg-purple-100 text-purple-700 hover:bg-purple-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}` }, `Buy (${r.cost})`)
          )
        ))
      );
    };

    const TimerView = ({ timerMode, setTimerMode, workTime, breakTime, setBreakTime, bankedTime, updateBanked, setWorkTime }) => {
      const startBreak = () => {
         updateBanked(0); 
         setBreakTime(Math.floor(workTime/5) + bankedTime); 
         setWorkTime(0); 
         setTimerMode('break'); 
      };
      
      return React.createElement('div', { className: 'flex flex-col items-center justify-center h-[70vh] fade-in space-y-8' },
         React.createElement('div', { className: `text-8xl md:text-9xl font-mono font-bold tracking-wider tabular-nums ${timerMode==='break'?'text-green-500':'text-gray-800 dark:text-white'}` }, 
           timerMode==='break' ? formatTime(breakTime) : formatTime(workTime)
         ),
         React.createElement('div', { className: 'flex gap-6' },
           timerMode==='idle' && React.createElement('button', { onClick: ()=>setTimerMode('work'), className: 'bg-gray-800 dark:bg-white text-white dark:text-gray-900 px-10 py-5 rounded-2xl text-xl font-bold hover:scale-105 transition shadow-lg' }, 'Start Focus'),
           timerMode==='work' && React.createElement('button', { onClick: startBreak, className: 'bg-green-500 text-white px-10 py-5 rounded-2xl text-xl font-bold hover:scale-105 transition shadow-lg' }, 'Take Break'),
           timerMode==='break' && React.createElement('button', { onClick: ()=>{ updateBanked(breakTime); setBreakTime(0); setTimerMode('idle'); }, className: 'bg-orange-500 text-white px-10 py-5 rounded-2xl text-xl font-bold hover:scale-105 transition shadow-lg' }, 'End Break')
         )
       );
    };

    const SettingsView = ({ user, syncStatus, handleLogin, handleLogout }) => {
      const requestNotify = async () => {
        if (!('Notification' in window)) return alert("Browser does not support desktop notifications");
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            new Notification("Notifications Enabled", { body: "You will be notified when timers end.", icon: 'âš¡' });
            playNotificationSound();
        }
      };

      return React.createElement('div', { className: 'space-y-8 fade-in' },
          React.createElement('h2', { className: 'text-2xl font-bold' }, 'Settings & Sync'),
          React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow space-y-4' },
            React.createElement('h3', { className: 'font-bold text-lg flex items-center gap-2' }, 'ðŸ”” Notifications'),
            React.createElement('p', { className: 'text-sm opacity-70' }, 'Enable audio and popup alerts for the timer.'),
            React.createElement('button', { onClick: requestNotify, className: 'bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center' }, React.createElement(Icon, { name: 'bell' }), 'Enable Notifications')
          ),
          React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow space-y-4' },
            React.createElement('h3', { className: 'font-bold text-lg flex items-center gap-2' }, 'â˜ï¸ Cloud Sync (Firebase)'),
            user ? React.createElement('div', { className: 'space-y-3' },
              React.createElement('div', { className: 'text-green-500 font-bold' }, `Logged in as ${user.email}`),
              React.createElement('div', { className: 'text-sm text-gray-500' }, `Status: ${syncStatus === 'syncing' ? 'Syncing...' : syncStatus === 'saved' ? 'All changes saved to cloud.' : 'Offline'}`),
              React.createElement('button', { onClick: handleLogout, className: 'bg-red-500 text-white px-4 py-2 rounded' }, 'Logout')
            ) : React.createElement('div', { className: 'space-y-3' },
              React.createElement('p', { className: 'text-sm opacity-70' }, 'Sign in to sync your habits, points, and tasks across your Phone and PC instantly.'),
              React.createElement('button', { onClick: handleLogin, className: 'bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center' }, React.createElement('span', null, 'G'), 'Sign in with Google')
            )
          )
      );
    };

    // --- 3. MAIN REACT APP ---
    const App = () => {
      // Data State
      const [habits, setHabits] = useState([]);
      const [tasks, setTasks] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [history, setHistory] = useState({});
      const [points, setPoints] = useState(0);
      const [passes, setPasses] = useState(3);
      const [bankedTime, setBankedTime] = useState(0);
      
      // UI State
      const [view, setView] = useState('dashboard');
      const [darkMode, setDarkMode] = useState(true);
      const [showTaskModal, setShowTaskModal] = useState(false);
      const [taskForm, setTaskForm] = useState({ title: '', priority: 'A', category: 'Work', due: '' });
      const categories = ['Morning', 'Evening', 'School', 'Work', 'Personal', 'Health'];

      // Timer State (TIMESTAMP MATH for precision)
      const [timerMode, setTimerMode] = useState('idle');
      const [workTime, setWorkTime] = useState(0);
      const [breakTime, setBreakTime] = useState(0);
      
      // We store the TIMESTAMP of when the session started/resumed
      const startTimeRef = useRef(0);
      // We store what the count was when we started/resumed
      const initialTimeRef = useRef(0);
      const initialBreakDurationRef = useRef(0);

      // Sync State
      const [user, setUser] = useState(null);
      const [syncStatus, setSyncStatus] = useState('offline'); 

      // GLOBAL TIMER LOGIC (Timestamp Math)
      useEffect(() => {
        let i; 
        
        // When mode changes to active, set the anchor timestamp
        if (timerMode === 'work') {
           startTimeRef.current = Date.now();
           initialTimeRef.current = workTime; // Resume from where we left off
        } else if (timerMode === 'break') {
           startTimeRef.current = Date.now();
           initialBreakDurationRef.current = breakTime;
        }

        if(timerMode !== 'idle') {
          // Update 10 times a second for smoothness, but use math for accuracy
          i = setInterval(() => {
            const now = Date.now();
            const elapsed = Math.floor((now - startTimeRef.current) / 1000);
            
            if (timerMode === 'work') {
              setWorkTime(initialTimeRef.current + elapsed);
            } else if (timerMode === 'break') {
              const remaining = initialBreakDurationRef.current - elapsed;
              if (remaining <= 0) {
                 setBreakTime(0);
                 setTimerMode('idle'); 
                 playNotificationSound(); 
                 if(Notification.permission==='granted') new Notification("Time's Up!", { body: "Break Over!", icon: 'âš¡' });
              } else {
                 setBreakTime(remaining);
              }
            }
          }, 100); // 100ms interval for responsive UI (no hitches)
        }
        return () => clearInterval(i);
      }, [timerMode]);

      // 1. Initial Load & Auth Listener
      useEffect(() => {
        const localDark = localStorage.getItem('dark');
        if (localDark) setDarkMode(JSON.parse(localDark));

        if (window.fbServices.auth) {
          const unsubscribe = window.fbServices.onAuthStateChanged(window.fbServices.auth, (currentUser) => {
            if (currentUser) {
              setUser(currentUser);
              setSyncStatus('syncing');
              const docRef = window.fbServices.doc(window.fbServices.db, "users", currentUser.uid);
              const unsubDoc = window.fbServices.onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                  const data = doc.data();
                  setHabits(data.habits || []);
                  setTasks(data.tasks || []);
                  setRewards(data.rewards || []);
                  setHistory(data.history || {});
                  setPoints(data.points || 0);
                  setPasses(data.passes || 3);
                  setBankedTime(data.bankedTime || 0);
                  setSyncStatus('saved');
                } else {
                  saveToCloud(currentUser.uid, { habits, tasks, rewards, history, points, passes, bankedTime });
                }
              });
              return () => unsubDoc();
            } else {
              setUser(null);
              setSyncStatus('offline');
              loadFromLocal();
            }
          });
          return () => unsubscribe();
        } else {
          loadFromLocal();
        }
      }, []);

      const loadFromLocal = () => {
        const load = (k, s, d) => { const v = localStorage.getItem(k); if(v) s(JSON.parse(v)); else s(d); };
        load('habits', setHabits, []);
        load('tasks', setTasks, []);
        load('rewards', setRewards, [{id:'r1',name:'Premium Coffee',cost:150}, {id:'r2',name:'Buy a Book/Movie',cost:300}, {id:'r3',name:'Sleep In',cost:200}]);
        load('history', setHistory, {});
        load('points', setPoints, 0);
        load('passes', setPasses, 3);
        load('banked', setBankedTime, 0);
      };

      const saveData = (newData) => {
        if(newData.habits) localStorage.setItem('habits', JSON.stringify(newData.habits));
        if(newData.tasks) localStorage.setItem('tasks', JSON.stringify(newData.tasks));
        if(newData.rewards) localStorage.setItem('rewards', JSON.stringify(newData.rewards));
        if(newData.history) localStorage.setItem('history', JSON.stringify(newData.history));
        if(newData.points !== undefined) localStorage.setItem('points', JSON.stringify(newData.points));
        if(newData.passes !== undefined) localStorage.setItem('passes', JSON.stringify(newData.passes));
        if(newData.bankedTime !== undefined) localStorage.setItem('banked', JSON.stringify(newData.bankedTime));
        localStorage.setItem('dark', JSON.stringify(darkMode));

        if (user && window.fbServices.db) {
          setSyncStatus('syncing');
          const currentData = { 
            habits: newData.habits || habits,
            tasks: newData.tasks || tasks,
            rewards: newData.rewards || rewards,
            history: newData.history || history,
            points: newData.points !== undefined ? newData.points : points,
            passes: newData.passes !== undefined ? newData.passes : passes,
            bankedTime: newData.bankedTime !== undefined ? newData.bankedTime : bankedTime,
            lastUpdated: new Date().toISOString()
          };
          saveToCloud(user.uid, currentData);
        }
      };

      const saveToCloud = async (uid, data) => {
        try {
          await window.fbServices.setDoc(window.fbServices.doc(window.fbServices.db, "users", uid), data, { merge: true });
          setSyncStatus('saved');
        } catch (e) {
          console.error("Cloud Save Failed", e);
          setSyncStatus('error');
        }
      };

      useEffect(() => {
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
        localStorage.setItem('dark', JSON.stringify(darkMode));
      }, [darkMode]);

      // Updaters
      const updateHabits = (newHabits) => { setHabits(newHabits); saveData({ habits: newHabits }); };
      const updateTasks = (newTasks) => { setTasks(newTasks); saveData({ tasks: newTasks }); };
      const updateRewards = (newRewards) => { setRewards(newRewards); saveData({ rewards: newRewards }); };
      const updatePoints = (newPoints) => { setPoints(newPoints); saveData({ points: newPoints }); };
      const updateBanked = (newBanked) => { setBankedTime(newBanked); saveData({ bankedTime: newBanked }); };

      const handleLogin = async () => {
        try {
          const provider = new window.fbServices.GoogleAuthProvider();
          await window.fbServices.signInWithPopup(window.fbServices.auth, provider);
        } catch (error) {
          alert("Login failed: " + error.message);
        }
      };

      const handleLogout = () => window.fbServices.signOut(window.fbServices.auth);

      const completeHabit = (id) => {
        const today = new Date().toISOString().split('T')[0];
        const habit = habits.find(h => h.id === id);
        if(!habit) return;
        const newHistory = {...history, [today]: {...(history[today]||{}), [id]: {completed: true, type: 'check'}}};
        setHistory(newHistory);
        setPoints(points + habit.points);
        saveData({ history: newHistory, points: points + habit.points });
      };

      const usePass = (id) => {
        if(passes <= 0) return;
        const today = new Date().toISOString().split('T')[0];
        const newHistory = {...history, [today]: {...(history[today]||{}), [id]: {completed: true, type: 'pass'}}};
        setHistory(newHistory);
        setPasses(passes - 1);
        saveData({ history: newHistory, passes: passes - 1 });
      };

      const addTask = () => {
        if(taskForm.title) { 
           updateTasks([...tasks, { ...taskForm, id: generateId(), completed: false }]); 
           setShowTaskModal(false); 
           setTaskForm({...taskForm, title: ''}); 
        }
      };
      
      const deleteTask = (id) => updateTasks(tasks.filter(t => t.id !== id));

      // --- LAYOUT ---
      return React.createElement('div', { className: 'min-h-screen flex flex-col md:flex-row' },
        React.createElement('header', { className: 'md:hidden bg-white dark:bg-gray-800 p-4 flex justify-between items-center shadow-sm z-20' }, React.createElement('div', { className: 'font-bold text-xl text-purple-500' }, 'FocusDash'), React.createElement('button', { onClick: () => setDarkMode(!darkMode) }, React.createElement(Icon, { name: darkMode ? 'sun' : 'moon' }))),
        React.createElement('nav', { className: 'fixed bottom-0 w-full h-16 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 z-30 md:relative md:w-20 md:h-screen md:border-t-0 md:border-r md:flex-col md:justify-start md:pt-6 flex justify-around items-center' },
           React.createElement('div', { className: 'hidden md:block mb-8 text-2xl animate-pulse' }, 'âš¡'),
           ['dashboard', 'tasks', 'timer', 'habits', 'rewards', 'settings'].map(v => React.createElement('button', { key: v, onClick: () => setView(v), className: `p-3 rounded-xl transition-all ${view === v ? 'bg-purple-100 text-purple-600 dark:bg-purple-900/50 dark:text-purple-300' : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-200'}` }, React.createElement(Icon, { name: v === 'dashboard' ? 'home' : v === 'timer' ? 'clock' : v === 'rewards' ? 'shop' : v === 'settings' ? 'settings' : v === 'habits' ? 'list' : 'tasks', size: 24 }))),
           React.createElement('div', { className: 'hidden md:flex flex-col gap-4 mt-auto mb-6' }, React.createElement('button', { onClick: () => setDarkMode(!darkMode), className: 'text-gray-400 hover:text-yellow-500' }, React.createElement(Icon, { name: darkMode ? 'sun' : 'moon' })))
        ),
        React.createElement('main', { className: 'flex-1 p-4 md:p-8 pb-24 md:pb-8 overflow-y-auto max-w-6xl mx-auto w-full' },
          view === 'dashboard' && React.createElement(DashboardView, { habits, history, points, passes, bankedTime, tasks, usePass, completeHabit, categories }),
          view === 'tasks' && React.createElement(TasksView, { tasks, updateTasks, setShowTaskModal, deleteTask }),
          view === 'timer' && React.createElement(TimerView, { timerMode, setTimerMode, workTime, setWorkTime, breakTime, setBreakTime, bankedTime, updateBanked, setWorkTime }),
          view === 'habits' && React.createElement(HabitsView, { habits, updateHabits, categories }),
          view === 'rewards' && React.createElement(RewardsView, { rewards, points, updatePoints, updateRewards }),
          view === 'settings' && React.createElement(SettingsView, { user, syncStatus, handleLogin, handleLogout }),
          showTaskModal && React.createElement('div', { className: 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4', onClick: () => setShowTaskModal(false) }, 
             React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-md space-y-4', onClick: e => e.stopPropagation() }, 
               React.createElement('h3', { className: 'text-xl font-bold' }, 'New Task'),
               React.createElement('input', { className: 'w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600', placeholder: 'Task Title', value: taskForm.title, onChange: e => setTaskForm({...taskForm, title: e.target.value}) }),
               React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                 React.createElement('select', { className: 'p-3 border rounded dark:bg-gray-700 dark:border-gray-600', value: taskForm.category, onChange: e => setTaskForm({...taskForm, category: e.target.value}) }, categories.map(c => React.createElement('option', { key:c, value:c }, c))),
                 React.createElement('select', { className: 'p-3 border rounded dark:bg-gray-700 dark:border-gray-600', value: taskForm.priority, onChange: e => setTaskForm({...taskForm, priority: e.target.value}) }, ['A', 'B', 'C', 'D'].map(p => React.createElement('option', { key:p, value:p }, `Priority ${p}`)))
               ),
               React.createElement('div', { className: 'space-y-1' },
                 React.createElement('label', { className: 'text-xs text-gray-500' }, 'Due Date & Time'),
                 React.createElement('input', { type: 'datetime-local', className: 'w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600', value: taskForm.due, onChange: e => setTaskForm({...taskForm, due: e.target.value}) })
               ),
               React.createElement('button', { onClick: addTask, className: 'w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700' }, 'Add Task')
             )
          )
        )
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>